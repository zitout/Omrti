<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة تقسيط العمرة</title>

    <!-- المكتبات المطلوبة -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* متغيرات CSS للسمات */
        :root {
            --primary-color: #ffffff;
            --secondary-color: #f0f0f0;
            --text-color: #333333;
            --accent-color: #4CAF50;
            --transition-speed: 0.3s;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* التنسيقات الأساسية */
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--primary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .calculator {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: var(--secondary-color);
            border-radius: 15px;
            box-shadow: var(--shadow);
            transform-style: preserve-3d;
            perspective: 1000px;
            transition: transform var(--transition-speed);
        }

        .input-group {
            margin-bottom: 20px;
            transform: translateZ(20px);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: inherit;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, background-color 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            background-color: #45a049;
        }

        #result {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transform: translateZ(30px);
        }

        /* تأثيرات 3D */
        .calculator {
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .input-group {
            transform: translateZ(20px);
            transition: transform var(--transition-speed);
        }

        .result-box {
            transform: translateZ(30px);
            transition: all var(--transition-speed);
        }

        /* أزرار المشاركة */
        .share-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .share-button {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            width: auto;
        }

        .share-button:hover {
            transform: translateY(-2px);
        }

        /* أنماط الطباعة */
        @media print {
            .no-print {
                display: none;
            }
            .calculator {
                box-shadow: none;
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- هيكل الحاسبة -->
    <div class="calculator">
        <div class="input-group">
            <label for="flightType">نوع الرحلة:</label>
            <select id="flightType">
                <option value="direct">مباشر</option>
                <option value="indirect">غير مباشر</option>
            </select>
        </div>

        <div class="input-group">
            <label for="persons">عدد الأشخاص:</label>
            <input type="number" id="persons" min="1" value="1">
        </div>

        <div class="input-group">
            <label for="months">عدد الأشهر:</label>
            <select id="months">
                <option value="3">3 أشهر</option>
                <option value="4">4 أشهر</option>
                <option value="5">5 أشهر</option>
                <option value="6">6 أشهر</option>
                <option value="7">7 أشهر</option>
                <option value="8">8 أشهر</option>
                <option value="9">9 أشهر</option>
                <option value="10">10 أشهر</option>
                <option value="11">11 شهر</option>
                <option value="12">12 شهر</option>
                <option value="13" selected>13 شهر</option>
                <option value="14">14 شهر</option>
                <option value="15">15 شهر</option>
                <option value="16">16 شهر</option>
                <option value="17">17 شهر</option>
                <option value="18">18 شهر</option>
            </select>
        </div>

        // تحسين دالة الحساب الرئيسية
function calculate() {
    const data = getCalculationParams();
    
    // التحقق من صحة المدخلات
    if (!validateInputs(data)) {
        showError('الرجاء التأكد من صحة المدخلات');
        return;
    }

    // التحقق من الذاكرة المؤقتة
    const cachedResult = getCachedCalculation(data);
    if (cachedResult) {
        enhancedResultDisplay(cachedResult);
        return;
    }

    // إرسال البيانات إلى Web Worker
    calculatorWorker.postMessage(data);
    showLoading();
}

// دالة التحقق من المدخلات
function validateInputs(data) {
    return (
        data.persons > 0 && 
        data.persons <= 50 &&
        data.months >= 3 &&
        data.months <= 18 &&
        data.downpayment >= 0
    );
}

// تحسين عرض النتائج
function updateResults(regularPayment, totalAmount) {
    const resultContainer = document.getElementById('result');
    
    const resultHTML = `
        <div class="result-content animate-on-scroll">
            <div class="result-header">
                <h2>نتيجة الحساب</h2>
                <div class="result-actions">
                    ${shareButtons}
                </div>
            </div>
            <div class="result-details">
                <div class="result-item">
                    <span class="result-label">القسط الشهري:</span>
                    <span class="result-value">${formatNumber(regularPayment)} ريال</span>
                </div>
                <div class="result-item">
                    <span class="result-label">إجمالي المبلغ:</span>
                    <span class="result-value">${formatNumber(totalAmount)} ريال</span>
                </div>
            </div>
            <div class="result-chart-container">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>
    `;
    
    resultContainer.innerHTML = resultHTML;
    createPaymentChart(regularPayment, totalAmount);
    animateResults();
}

// إضافة رسم بياني للنتائج
function createPaymentChart(regularPayment, totalAmount) {
    const ctx = document.getElementById('paymentChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['الأقساط الشهرية', 'الدفعة المقدمة'],
            datasets: [{
                data: [regularPayment, totalAmount - regularPayment],
                backgroundColor: ['#4CAF50', '#2196F3']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// تحسين عرض رسالة التحميل
function showLoading() {
    const resultContainer = document.getElementById('result');
    resultContainer.innerHTML = `
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>جاري الحساب...</p>
        </div>
    `;
}

// تحسين عرض رسائل الخطأ
function showError(message) {
    const resultContainer = document.getElementById('result');
    resultContainer.innerHTML = `
        <div class="error-container animate-on-scroll">
            <i class="fas fa-exclamation-circle"></i>
            <p>${message}</p>
        </div>
    `;
}

// تحسين تنسيق الأرقام
function formatNumber(number) {
    return new Intl.NumberFormat('ar-SA', {
        style: 'decimal',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(number);
}

// تحسين أداء الرسوم المتحركة
function animateResults() {
    gsap.from('.result-content', {
        opacity: 0,
        y: 20,
        duration: 0.5,
        ease: 'power2.out'
    });

    gsap.from('.result-item', {
        opacity: 0,
        x: -20,
        duration: 0.5,
        stagger: 0.1,
        ease: 'power2.out'
    });

    gsap.from('.result-chart-container', {
        opacity: 0,
        scale: 0.9,
        duration: 0.5,
        delay: 0.3,
        ease: 'back.out(1.7)'
    });
}

            // تحسين دالة الحساب الرئيسية
function calculate() {
    const data = {
        flightType: document.getElementById('flightType').value,
        persons: parseInt(document.getElementById('persons').value),
        months: parseInt(document.getElementById('months').value),
        downpayment: parseFloat(document.getElementById('downpayment').value) || 0
    };

    // التحقق من صحة المدخلات
    if (!validateInputs(data)) {
        showError('الرجاء التأكد من صحة المدخلات');
        return;
    }

    // التحقق من الذاكرة المؤقتة
    const cachedResult = getCachedCalculation(data);
    if (cachedResult) {
        enhancedResultDisplay(cachedResult);
    } else {
        showLoading();
        calculatorWorker.postMessage(data);
    }
}

// تحسين عرض النتائج
function enhancedResultDisplay(result) {
    const resultContainer = document.getElementById('result');
    
    const resultHTML = `
        <div class="result-content animate-on-scroll">
            <div class="result-header">
                <h2>نتيجة الحساب</h2>
            </div>
            <div class="result-details">
                <div class="result-item">
                    <span class="result-label">نوع الرحلة:</span>
                    <span class="result-value">${result.flightType === 'direct' ? 'مباشر' : 'غير مباشر'}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">عدد الأشخاص:</span>
                    <span class="result-value">${result.persons}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">عدد الأشهر:</span>
                    <span class="result-value">${result.months}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">القسط الشهري:</span>
                    <span class="result-value">${formatNumber(result.regularPayment)} ريال</span>
                </div>
                <div class="result-item">
                    <span class="result-label">إجمالي المبلغ:</span>
                    <span class="result-value">${formatNumber(result.totalAmount)} ريال</span>
                </div>
            </div>
            <div class="result-actions">
                ${shareButtons}
                <button onclick="generateEnhancedPDF()" class="action-button">
                    <i class="fas fa-file-pdf"></i> تحميل PDF
                </button>
            </div>
        </div>
    `;
    
    resultContainer.innerHTML = resultHTML;
    animateResults();
}

// تحسين عرض رسالة التحميل
function showLoading() {
    const resultContainer = document.getElementById('result');
    resultContainer.innerHTML = `
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>جاري الحساب...</p>
        </div>
    `;
}

// تحسين عرض رسائل الخطأ
function showError(message) {
    const resultContainer = document.getElementById('result');
    resultContainer.innerHTML = `
        <div class="error-container animate-on-scroll">
            <i class="fas fa-exclamation-circle"></i>
            <p>${message}</p>
        </div>
    `;
}

// تحسين التحقق من المدخلات
function validateInputs(data) {
    if (!data.persons || data.persons < 1 || data.persons > 50) {
        showError('عدد الأشخاص يجب أن يكون بين 1 و 50');
        return false;
    }

    if (!data.months || data.months < 3 || data.months > 18) {
        showError('عدد الأشهر يجب أن يكون بين 3 و 18');
        return false;
    }

    if (data.downpayment < 0) {
        showError('الدفعة المقدمة يجب أن تكون 0 أو أكثر');
        return false;
    }

    return true;
}

// تحسين تنسيق الأرقام
function formatNumber(number) {
    return new Intl.NumberFormat('ar-SA', {
        style: 'decimal',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(number);
}

// إضافة CSS جديد للتحسينات
const newStyles = `
    .loading-container {
        text-align: center;
        padding: 2rem;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--secondary-color);
        border-top: 5px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-container {
        background-color: #ffebee;
        color: #c62828;
        padding: 1rem;
        border-radius: 5px;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .result-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .action-button {
        padding: 0.5rem 1rem;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: transform 0.2s;
        background-color: var(--accent-color);
        color: white;
    }

    .action-button:hover {
        transform: translateY(-2px);
    }
`;

// إضافة الأنماط الجديدة إلى الصفحة
const styleSheet = document.createElement('style');
styleSheet.textContent = newStyles;
document.head.appendChild(styleSheet);

        // إضافة دالة لتحسين عرض النتائج مع الرسوم البيانية
function createResultChart(result) {
    const chartContainer = document.querySelector('.result-chart');
    const canvas = document.createElement('canvas');
    chartContainer.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['القسط الشهري', 'الدفعة المقدمة', 'إجمالي الربح'],
            datasets: [{
                data: [
                    result.regularPayment,
                    result.downpayment,
                    result.totalAmount - (result.regularPayment * result.months + result.downpayment)
                ],
                backgroundColor: ['#4CAF50', '#2196F3', '#FFC107']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            family: 'Tajawal'
                        }
                    }
                }
            }
        }
    });
}

// تحسين التحقق من المدخلات
function validateEnhanced(data) {
    const errors = [];
    
    if (!data.persons || data.persons < 1) {
        errors.push('عدد الأشخاص يجب أن يكون 1 على الأقل');
    }
    
    if (data.persons > 50) {
        errors.push('الحد الأقصى لعدد الأشخاص هو 50');
    }
    
    if (!data.months || !RATES[data.months]) {
        errors.push('يرجى اختيار عدد الأشهر المناسب');
    }
    
    if (data.downpayment < 0) {
        errors.push('الدفعة المقدمة لا يمكن أن تكون سالبة');
    }
    
    return {
        isValid: errors.length === 0,
        errors: errors
    };
}

// تحسين عرض الأخطاء
function showEnhancedError(errors) {
    const resultContainer = document.getElementById('result');
    const errorHTML = `
        <div class="error-container animate-fade-in">
            <div class="error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="error-list">
                ${errors.map(error => `<p class="error-item">${error}</p>`).join('')}
            </div>
        </div>
    `;
    resultContainer.innerHTML = errorHTML;
}

// تحسين تجربة المستخدم مع التحميل
function showEnhancedLoading() {
    const resultContainer = document.getElementById('result');
    const loadingHTML = `
        <div class="loading-container animate-fade-in">
            <div class="loading-spinner"></div>
            <p class="loading-text">جاري حساب النتائج...</p>
        </div>
    `;
    resultContainer.innerHTML = loadingHTML;
}

// إضافة أنماط CSS جديدة للتحسينات
const enhancedStyles = `
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--secondary-color);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        margin-top: 1rem;
        color: var(--text-color);
        font-size: 1.1rem;
    }

    .error-container {
        background-color: #ffebee;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .error-icon {
        color: #c62828;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .error-item {
        color: #c62828;
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }

    .result-chart {
        margin-top: 2rem;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
`;

// إضافة الأنماط الجديدة إلى الصفحة
const styleElement = document.createElement('style');
styleElement.textContent = enhancedStyles;
document.head.appendChild(styleElement);

// تحسين الأداء العام
function optimizeOverallPerformance() {
    // تحسين تحميل الصور
    document.querySelectorAll('img').forEach(img => {
        if (img.getAttribute('loading') !== 'lazy') {
            img.setAttribute('loading', 'lazy');
        }
    });

    // تحسين تحميل الخطوط
    if ('fonts' in document) {
        document.fonts.ready.then(() => {
            document.documentElement.classList.add('fonts-loaded');
        });
    }

    // تحسين أداء الرسوم المتحركة
    document.querySelectorAll('.animate-on-scroll').forEach(element => {
        element.style.willChange = 'transform, opacity';
    });
}

// تشغيل جميع التحسينات
document.addEventListener('DOMContentLoaded', () => {
    initializeEnhancements();
    optimizeOverallPerformance();
});
        
